---
import BaseHead from "../../../components/BaseHead.astro";
import Header from "../../../components/Header.astro";
import Footer from "../../../components/Footer.astro";
import { SITE_TITLE, SITE_DESCRIPTION } from "../../../consts";
import { getCollection } from "astro:content";
import FormattedDate from "../../../components/FormattedDate.astro";
import Tags from "../../../components/Tags.astro";

export async function getStaticPaths() {
  const posts = await getCollection("blog");
  const tags = [...new Set(posts.flatMap((post) => post.data.tags || []))];

  return tags.map((tag) => ({
    params: { tag },
    props: {
      posts: posts
        .filter((post) => post.data.tags?.includes(tag))
        .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()),
    },
  }));
}

const { tag } = Astro.params;
const { posts } = Astro.props;
---

<!doctype html>
<html lang="en">
  <head>
    <BaseHead
      title={`${tag} | ${SITE_TITLE}`}
      description={`${SITE_DESCRIPTION} - Posts tagged with ${tag}`}
    />
    <style>
      main {
        width: 100%;
        max-width: 1200px;
        margin: 0 auto;
      }
      ul {
        list-style: none;
        padding: 0;
        margin: 0 auto;
      }
      ul li {
        display: flex;
        flex-wrap: wrap;
        align-items: flex-baseline;
        gap: 1rem;
        padding: 1rem 0;
      }
      ul li * {
        text-decoration: none;
        transition: 0.2s ease;
      }
      .title {
        margin: 0;
        flex: 0 0 50%;
        min-width: 200px;
        color: var(--color-primary);
        line-height: 1;
        font-size: 2rem;
      }
      .date {
        margin: 0;
        flex: 0 0 130px;
        color: var(--color-secondary);
        font-size: 1rem;
      }
      .back-link {
        display: block;
        margin-bottom: 2rem;
        color: var(--color-secondary);
        text-decoration: none;
      }
      .back-link:hover {
        text-decoration: underline;
      }
      @media (max-width: 720px) {
        ul li {
          gap: 0.5rem;
        }
        .title {
          flex: 1 0 100%;
          font-size: 1.5rem;
        }
        .date {
          flex: 0 0 100%;
        }
      }
    </style>
  </head>
  <body>
    <Header />
    <main>
      <section>
        <a href="/blog/tags/" class="back-link">‚Üê All Tags</a>
        <h1>Posts tagged with "{tag}"</h1>
        <ul>
          {
            posts.map((post) => (
              <li>
                <span class="date">
                  <FormattedDate date={post.data.pubDate} />
                </span>
                <span class="title">
                  <a href={`/blog/${post.id}/`}>{post.data.title}</a>
                </span>
                <span class="tags">
                  {post.data.tags && <Tags tags={post.data.tags} />}
                </span>
              </li>
            ))
          }
        </ul>
      </section>
    </main>
    <Footer />
  </body>
</html>
